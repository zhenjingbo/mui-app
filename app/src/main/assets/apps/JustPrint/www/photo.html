<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title></title>
    <link href="css/mui.min.css" rel="stylesheet" />
    <link href="css/style.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/cropper.min.css" />
    <style type="text/css">
      .mui-content{
        text-align: center;
        background: #FFFFFF;
      }
      .logo{
        width:50%;
        margin-top: -10%;
      }
      .slogan{
        margin-top: -15%;
        letter-spacing:8px;
        color: rgb(0,160,233);
        font-size: 18px;
      }
      .photo-fee{
        color:grey;
        margin-top: -5px;
        letter-spacing:1px;
      }
      ul{
         width:60%;
         height:50%;
       display: inline-block;
       margin-top:2%;
      }
      ul li{
        width:100%;
        height:30%;
        position: relative;
        margin-top:10%;
      }
      li img{
        width:100%;
      }
      li p{
        position: absolute;
        top:30%;
        right:20%;
        font-size: 16px;
      }
      .fileList{
        position: fixed;
        left: 0;
        right: 0;
        margin: auto;
        bottom:5%; 
        color: grey;
      }
      .fileList img{
        width: 20px;
        vertical-align: middle;
      }
    </style>
     <style>
        .container { padding: 0; margin: 0; }
        /*剪切页面 预览页面共用*/
        .crop_panel { overflow: hidden; margin: 0; background: #000;}
        .top_actions { display: flex; justify-content: space-between; align-items: center; height:10%;}
        .top_actions p{margin: 5px;color:#000000;}
        .top_actions .act_back { background: url(img/back.png) no-repeat 10px center; padding-left: 40px; font-size: 18px; height: 34px; line-height: 34px; background-size: contain; color: #333; }
        .top_actions .act_back:active { opacity: .7; }
        .normal_actions { display: flex; justify-content: space-between; align-items: center; height: 9%;}
        .normal_actions a { font-size: 18px; padding: 0 15px; color: #000;margin-top:5%;}
        .normal_actions a:active { opacity: .7; }
        .normal_actions a.act_next { color: #00A0E9; }
        .crop_container { height:90%; padding-top: 13%; }
        /*剪裁框*/
        .cropper-modal { opacity: .7; }
        .cropper-view-box { outline: 1px dashed #000; background: #fff; }
    </style>
    <!--首页-->
    <style>
        .logo_panel { padding: 6% 0; text-align: center; }
        .logo_panel img { width: 46%; }
        .logo_panel .title { color: #00A0E9; letter-spacing: 6px; font-size: 18px; }
        .dev_info { color: #666; font-size: 16px; line-height: 20px; }
        .act_entry { margin: 0 10% 8% 10%; height: 15%; }
         #preview{height: 100%;width: 100%;overflow: hidden;}
        .btn_normal { background: url(img/photo_normal.jpg) no-repeat center; color: #03a55b; }
        .btn_ident1 { background: url(img/photo_ident1.jpg) no-repeat center; color: #efbe09; }
        .btn_ident2 { background: url(img/photo_ident2.jpg) no-repeat center; color: #d81d0e; }
        .btn_goto { height: 100%; background-size: contain; text-align: center; -webkit-tap-highlight-color: rgba(255,0,0,0); }
        .btn_goto span { font-size: 22px; padding-left: 80px; padding-top: 6%; display: inline-block; }
        .btn_goto:active { opacity: .7; }
        .my_files { text-align: center; display: flex; justify-content: center; align-items: center; }
        .my_files a { color: grey; }
        .my_files img { height: 30px; }
    /*<!--预览页-->*/
         #preview{width:100%;height:100%;padding-top:0.8%;}
        .swiper-container { height:90%; background: #000;}
        .swiper-wrapper{height: 100%;}
        .swiper-slide { text-align: center;height:100%;width: 100%;}
        .swiper-slide img {width: 100%;padding: 10%;height: 100%;}
        .swiper-slide img.rotate90 { transform: rotate(90deg); -webkit-transform: rotate(90deg); }
        #photo_info span { padding: 0 10px; }
        #photo_submit { height: 10%; width: 100%; border-collapse: collapse;}
        #photo_submit td { height: 100%; text-align: center; vertical-align: middle; font-size: 18px; }
        #photo_submit .total_fee { width: 60%; color: #666; }
        #photo_submit .btn_submit { width: 40%; padding: 0; background: red; color: #fff;height: 100%;}
        #total_fee { color: red; }
    </style>
    <!--	初始化方法-->
    <script src="js/init.js"></script>
     <script>
        //dataURLtoBlob   ios不支持toBlob方法
        !function (t) { "use strict"; var e = t.HTMLCanvasElement && t.HTMLCanvasElement.prototype, o = t.Blob && function () { try { return Boolean(new Blob) } catch (t) { return !1 } }(), n = o && t.Uint8Array && function () { try { return 100 === new Blob([new Uint8Array(100)]).size } catch (t) { return !1 } }(), r = t.BlobBuilder || t.WebKitBlobBuilder || t.MozBlobBuilder || t.MSBlobBuilder, a = /^data:((.*?)(;charset=.*?)?)(;base64)?,/, i = (o || r) && t.atob && t.ArrayBuffer && t.Uint8Array && function (t) { var e, i, l, u, b, c, d, B, f; if (e = t.match(a), !e) throw new Error("invalid data URI"); for (i = e[2] ? e[1] : "text/plain" + (e[3] || ";charset=US-ASCII"), l = !!e[4], u = t.slice(e[0].length), b = l ? atob(u) : decodeURIComponent(u), c = new ArrayBuffer(b.length), d = new Uint8Array(c), B = 0; B < b.length; B += 1) d[B] = b.charCodeAt(B); return o ? new Blob([n ? d : c], { type: i }) : (f = new r, f.append(c), f.getBlob(i)) }; t.HTMLCanvasElement && !e.toBlob && (e.mozGetAsFile ? e.toBlob = function (t, o, n) { t(n && e.toDataURL && i ? i(this.toDataURL(o, n)) : this.mozGetAsFile("blob", o)) } : e.toDataURL && i && (e.toBlob = function (t, e, o) { t(i(this.toDataURL(e, o))) })), "function" == typeof define && define.amd ? define(function () { return i }) : "object" == typeof module && module.exports ? module.exports = i : t.dataURLtoBlob = i }(window);
    </script>
 
  </head>

  <body>
    <header class="mui-bar mui-bar-nav">
      <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"><span style="font-size: 18px;">返回</span></a>
      <h1 class="mui-title">照片打印</h1>
    </header>
    <div class="mui-content">
        <!--进入页-->
      <div id="index" >
      <img src="img/icon-LOGO.svg" class="logo" />
      <p class="slogan">欢迎使用照片打印</p>
      <p class="photo-fee" id="photo-std"></p>
      <ul>
        <li id="file_normal">
        <img src="img/photo_normal.jpg" alt="" />
        <p style="color:rgb(3,189,106);">照片打印</p>
        </li>
        <li id="file_ident_1" onclick="$('#file_ident_1').click()">
        <img src="img/photo_ident1.jpg" alt="" />
        <p style="color:rgb(253,208,58);">1寸证件照</p>
        </li>
        <li id="file_ident_2" onclick="$('#file_ident_2').click()">
        <img src="img/photo_ident2.jpg" alt="" />  
        <p style="color:rgb(250,43,27);">2寸证件照</p>
        </li>
      </ul>
      <p class="fileList"><img src="img/my_files.jpg" alt="" />未打印列表</p>
      </div>
       <!--普通照片-->
        <div id="photo_normal" style="display: none;">
            <div class="top_actions">
               <a class="act_back" onclick="backIndex()"><!--选择--></a>
            </div>
            <div class="crop_panel" id="crop_body">
                <div class="crop_container">
                    <img id="normal_img" style="display: none" />
                </div>
            </div>
            <div class="normal_actions">
                <a class="act_rotate" onclick="rotateimg(90)">旋转</a>
                <a class="act_next" onclick="submitCrop()">完成</a>
            </div>
        </div>
        
              <!--证件照-->
        <div id="photo_ident" style="display: none;">
            <div class="top_actions">
                <a class="act_back" onclick="gRouter.back()">选择</a>
            </div>
            <div class="crop_panel">
                <div class="crop_container">
                    <img id="ident_img" style="display: none" />
                </div>
            </div>
            <div class="normal_actions">
                <a class="act_rotate" onclick="rotateimg(90)">旋转</a>
                <a class="act_next" onclick="submitCrop()">完成</a>
            </div>
        </div>
        
         <!--预览-->
        <div id="preview" style="display: none;">
            <div class="top_actions">
                <a class="act_back" onclick="gRouter.back()"></a>
                <div id="photo_info">
                    <p><span class="img_num"></span>|<span class="img_size"></span>|<span class="img_price"></span></p>
                </div>
            </div>
            <div id="swiper_container" class="swiper-container" data-space-between='0' data-pagination='.swiper-pagination' data-autoplay="0">
                <div class="swiper-wrapper">
                </div>
            </div>
            <table id="photo_submit">
                <tr>
                    <td class="total_fee">
                        <span style="text-align: left; display: inline-block; line-height: 20px; padding-top: 6px;">
                            <span>合计：<span id="total_fee"></span></span><br />
                            <span style="font-size: 12px;">钱包余额：<span id="wallet_balance"></span></span>
                        </span>
                    </td>
                    <td class="btn_submit" onclick="submitPrint()">
                        <div>打印</div>
                        <div id="charge_m" style="font-size: 12px"></div>
                    </td>
                </tr>
            </table>
        </div>
        
                <!--错误-->
        <div id="error_msg" style="display: none;">
            <div class="weui-msg">
                <div class="weui-msg__icon-area"><i id="jp_icon" class="weui-icon_msg weui-icon-warn"></i></div>
                <div class="weui-msg__text-area">
                    <h2 id="jp_title" class="weui-msg__title">设备异常</h2>
                    <p id="jp_msg" class="weui-msg__desc"></p>
                </div>
                <div class="weui-msg__opr-area">
                    <p class="weui-btn-area">
                        <a href="javascript:;" class="weui-btn weui-btn_primary" onclick="WeixinJSBridge.call('closeWindow')">关闭</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
    <!-- page code -->
    <script src="js/mui.min.js"></script>
    <script src="js/uni.lib.js"></script>
    <script src="js/pro.lib.js"></script>
    <script src="js/app.js"></script>
    <script src="js/jquery-3.2.1.min.js"></script>
    <script src="js/jquery-3.2.1.js"></script>
    <script src="js/cropper.js"></script>
    <script type='text/javascript' src='js/swiper.min.js'></script>

    <script type="text/javascript">
      mui.init();
      var gCrop;
      var gCurFiles;
      var gImgList;
      var gRouter;
      var gOptions;
      var devSN;
      var imgUrl;
      mui.plusReady(function() {
        
        plus.webview.currentWebview().setStyle({
       scrollIndicator: 'none'
         });
         document.addEventListener('touchstart',function(e){e.preventDefault();})
      $("#crop_body").height(window.document.body.offsetHeight*0.78);
       document.getElementById("file_normal").addEventListener("tap",function(){
        if(mui.os.plus) {　　　　　　
          var a = [{　　　　　　　　
            title: "拍照" //这些都是可以点击的选项的内容      　　　　　　
          }, {　　　　　　　　
            title: "从手机相册选择"　　　　
          }];　　　　　　
          plus.nativeUI.actionSheet({　　　　　　　　
            title: "上传照片", //这里就是这个弹窗的title
            　　　　　　　　cancel: "取消", //取消按钮
            　　　　　　　　buttons: a　　　　　　
          }, function(b) {
            switch(b.index) {
              case 1:
                clickCamera();
                break;
              case 2:
                clickGallery();
                break;
            }　　　　　　
          })　　　　
        }　
      },false);
      document.getElementById("file_ident_1").addEventListener("tap",function(){
        if(mui.os.plus) {　　　　　　
          var a = [{　　　　　　　　
            title: "拍照" //这些都是可以点击的选项的内容      　　　　　　
          }, {　　　　　　　　
            title: "从手机相册选择"　　　　
          }];　　　　　　
          plus.nativeUI.actionSheet({　　　　　　　　
            title: "上传照片", //这里就是这个弹窗的title
            　　　　　　　　cancel: "取消", //取消按钮
            　　　　　　　　buttons: a　　　　　　
          }, function(b) {
            switch(b.index) {
              case 1:
                clickCamera();
                break;
              case 2:
                clickGallery();
                break;
            }　　　　　　
          })　　　　
        }　
      },false);
      document.getElementById("file_ident_2").addEventListener("tap",function(){
        if(mui.os.plus) {　　　　　　
          var a = [{　　　　　　　　
            title: "拍照" //这些都是可以点击的选项的内容      　　　　　　
          }, {　　　　　　　　
            title: "从手机相册选择"　　　　
          }];　　　　　　
          plus.nativeUI.actionSheet({　　　　　　　　
            title: "上传照片", //这里就是这个弹窗的title
            　　　　　　　　cancel: "取消", //取消按钮
            　　　　　　　　buttons: a　　　　　　
          }, function(b) {
            switch(b.index) {
              case 1:
                clickCamera();
                break;
              case 2:
                clickGallery();
                break;
            }　　　　　　
          })　　　　
        }　
      },false);
        app.onPageLoad(function(para){
//          var devSN = getReq()["dev"];
              if(para){
            devSN = para.devSN;
          }
            gOptions = {
                size: 281,//默认5寸
                paper: "5寸照片",
                ratio: 3.5 / 5,
                feeSTD: null,
                device: null,
                balance: null,
                domain: location.origin + "/uniwx/",
                devSN: devSN
            };
            $("#container").height(window.innerHeight);
            gRouter = new router($("#container"), $("#templates"));
            preparePrint(devSN, function () {
                var opt = gOptions;
                var dev = opt.device;
                if ((dev.dwStatus & (0x400 | 0x80 | 0x20 | 0x10)) > 0) {//不能使用
                    gotoErrorMsg(dev.szStatInfo);//"打印机不能正常使用"
                    return;
                }

                gRouter.goto("index", function (m) {
                    var std = app.getFeeSTD(devSN);
                    alert(JSON.stringify(std));
                    if (std) {
                        var uf = std.dwColorFee + std.dwMaterialFee;
                        $("#dev_info").html(opt.paper + " " + app.cvtFee(uf) + "元/张");
                    }
                    $("#file_normal").change(function () {
                        processFile(this, "normal");
                    });
                    $("#file_ident_1").change(function () {
                        processFile(this, "ident1");
                    });
                    $("#file_ident_2").change(function () {
                        processFile(this, "ident2");
                    });
                });

            });
        });
        function processFile(input, type) {
            var opt = gOptions;
            gCurFiles = input.files;
            gImgList = [];
            if (gCurFiles.length > 0) {
                if (type == "normal") {
                    opt.mSize = 5, opt.ratio = 3.5 / 5;//5寸
                    opt.size == 285 && (opt.mSize = 6, opt.ratio = 4 / 6);//6寸
                    opt.type = "normal";
                    gRouter.goto("photo_normal", showNormal);
                }
                else if (type == "ident1") {
                    opt.ratio = 2.5 / 3.5;
                    opt.type = "ident";
                    opt.mSize = 1;
                    gRouter.goto("photo_ident", showIdent);
                }
                else if (type == "ident2") {
                    opt.ratio = 3.3 / 5.3;
                    opt.type = "ident";
                    opt.mSize = 2;
                    gRouter.goto("photo_ident", showIdent);
                }
            }
        }
         //相册选择  
      function clickGallery() {
        //每次拍摄或选择图片前清空数组对象
                f1.splice(0, f1.length);
                document.getElementsByClassName("showimg")[0].innerHTML = null;
                // 从相册中选择图片
                mui.toast("从相册中选择不超过两张图片");
                plus.gallery.pick(function(e) {
                    if (e.files.length != 2) {
                        mui.toast('请选择身份证正面和背面照片共两张');
                        return false;
                    }
                    for (var i in e.files) {
                        showImg(e.files[i]);
                    }
                }, function(e) {
                    mui.toast("取消选择图片");
                }, {
                    filter: "image",
                    multiple: true
                });
      };
      
function showImg(url) {
    // 兼容以“file:”开头的情况
    if (0 != url.toString().indexOf("file://")) {
        url = "file://" + url;
    }
    var _div_ = document.getElementsByClassName("showimg")[0];
    var _img_ = new Image();
    _img_.src = url; // 传过来的图片路径在这里用。
        _img_.onclick = function() {
                plus.runtime.openFile(url);
            };
    _img_.onload = function() {
        var tmph = _img_.height;
        var tmpw = _img_.width;
        var isHengTu = tmpw > tmph;
        var max = Math.max(tmpw, tmph);
        var min = Math.min(tmpw, tmph);
        var bili = min / max;
        if (max > 1200) {
            max = 1200;
            min = Math.floor(bili * max);
        }
        tmph = isHengTu ? min : max;
        tmpw = isHengTu ? max : min;
        _img_.style.border = "1px solid rgb(200,199,204)";
        _img_.style.margin = "10px";
        _img_.style.width = "150px";
        _img_.style.height = "150px";
        _img_.onload = null;
        plus.io.resolveLocalFileSystemURL(url, function(entry) {
                entry.file(function(file) {
                    console.log(file.size + '--' + file.name);
                    canvasResize(file, {
                        width: tmpw,
                        height: tmph,
                        crop: false,
                        quality: 50, //压缩质量
                        rotate: 0,
                        callback: function(data, width, height) {
                            f1.push(data);
                            _img_.src = data;
                            _div_.appendChild(_img_);
                            plus.nativeUI.closeWaiting();
                        }
                    });
                });
            },
            function(e) {
                plus.nativeUI.closeWaiting();
                console.log(e.message);
            });
    };
};

        function imgupgrade() {
                mui.toast('后台联调时启用上传功能');
                return;
                var wt = plus.nativeUI.showWaiting();
                var url = '后台地址';
                var dataType = 'json';
                //发送数据  
                var data = {
                    files1: f1 //base64数据        
                };
                mui.post(url, data, success, dataType);
            }
            //成功响应的回调函数
        var success = function(response) {
            plus.nativeUI.closeWaiting();
            if (response != null) {
                alert("上传成功");
            }
        }
          // 拍照  
      function clickCamera() {
        var cmr = plus.camera.getCamera();
        var res = cmr.supportedImageResolutions[0];
        var fmt = cmr.supportedImageFormats[0];
        cmr.captureImage(function(path) {
          plus.io.resolveLocalFileSystemURL(path, function(entry) {
            localUrl = entry.toLocalURL();
            plus.zip.compressImage({
              src: localUrl,
              dst: "_doc/chat/camera/" + localUrl,
              quality: 20,
              overwrite: true
            }, function(e) {
               gCrop = $("#normal_img");
//             loadImg(0);
//            readFile(localUrl);
               showImage(localUrl);
            }, function(err) {
              console.log("压缩失败：  " + err.message);
            });
          });
        }, function(err) {
          console.error("拍照失败：" + err.message);
        }, {
          index:1
        });
        
      };
      //显示图片
      function showImage(path) {
        $("#index").hide();
        $("#photo_normal").css("display","block");
        plus.nativeUI.showWaiting("图片处理中");
        var base64Img = path;
        var img = new Image();
        img.src = base64Img;
        img.onload = function() {
          var c = compressImg(img);
          var resizeImgBase64 = c.toDataURL("image/jpeg", 0.95);
          plus.nativeUI.closeWaiting();
          initCropper(resizeImgBase64);
        }
        img.onerror = function () {
                    loadError("载入图片失败");
                }
      };
       function loadImg(index) {
            plus.nativeUI.showWaiting();
            setTimeout(function () {
                var f = gCurFiles[index];
                if (f) {
                    gCrop.index = index;
                    readFile(f);
                }
                else {
                    gCrop.index = -1;
                    loadError("未选择文件");
                }
            }, 200);
        };
      function readFile(file) {
            var f = file;
            var reader = new FileReader();
            reader.onload = function (e) {
                var base64Img = e.target.result;
                var img = new Image();
                img.src = base64Img;
                img.onload = function () {
                    var c = compressImg(img);
                    var resizeImgBase64 = c.toDataURL("image/jpeg", 0.95);
                    initCropper(resizeImgBase64);
                    plus.nativeUI.closeWaiting();
                }
                img.onerror = function () {
                    loadError("载入图片失败");
                }
            };
            reader.onerror = function () {
                loadError("读取文件失败");
            }
            reader.readAsDataURL(f);
        }
      function initCropper(src) {
            //1寸 2.5*3.5cm 413*295
            //身份证大头照 3.3*2.2 390*260
            //2寸 3.5*5.3cm 626*413
            //小2寸（护照） 4.8*3.3cm 567*390
            //5 寸 5x3.5 12.7*8.9 1200x840以上 100万像素
            //6 寸 6x4 15.2*10.2 1440x960以上 130万像素
            var img = gCrop;
            var opt = gOptions;
            var ratio = opt.ratio;
            //if (opt.size == 285) {
            //    ratio = 4 / 6;
            //}
            if (!img.hasClass("inited")) {
                img.addClass("inited");
                img.attr("src", src);
                img.cropper({
                    modal: true,
                    aspectRatio: ratio,
                    autoCropArea: 1,
                    viewMode: 0,
                    dragMode: "move",
                    responsive: false,
                    cropBoxMovable: false,//移动剪裁框
                    cropBoxResizable: false,//改变剪裁框尺寸
                    toggleDragModeOnDblclick: false
                });
            }
            else {
                img.cropper("replace", src);
            }
        }
      function preparePrint(sn, callback) {
            postData("print.aspx", {
                act: "prepare_print",
                delay: "true",
                dev_sn: sn
            }, function (rlt) {
                if (rlt.ret == 1) {
                    var data = rlt.data;
                    var opt = gOptions;
                    opt.acc = data.acc;
                    var printer = data.printer;
                    var pp = printer.dwTrayPaper1;
                    if (pp) {// && (pp == 285 || pp == 281)
                        opt.device = printer;
                        opt.feeSTD = calcSTD(data.feeSTD);
                        opt.size = pp;
                        if (opt.feeSTD[pp]) {
                            opt.paper = opt.feeSTD[pp].szFeeName;
                            opt.stamp = data.stamp;
                            getBalance(printer.dwComSN, callback);
                        }
                        else {
                            gotoErrorMsg("费率未配置");
                        }
                    }
                    else {
                        gotoErrorMsg("设备不存在");
                    }
                }
                else {
                    gotoErrorMsg(rlt.msg);
                }
            }, function () { plus.nativeUI.showWaiting(); }, function () { plus.nativeUI.closeWaiting(); });
        }
     
       
              function postData(url, data, suc, before, complete) {
//          $.ajax({
//              type: "POST",
//              timeout: 200000,
//              url: gOptions.domain + "ajax/" + url,
//              data: data,
//              dataType: "json",
//              success: suc,
//              error: function (error) {
//                  this.error = error;
//                  var msg = "异步连接出现异常！";
//                  if (error.statusText == "timeout")
//                      msg = "服务器没有响应，连接超时！";
//                  alert(msg);
//                  console.log("msg", msg + "/status:" + error.statusText, error.responseText);
//              },
//              beforeSend: before,
//              complete: complete
//          });
        }
                      function rotateimg(v) {
            gCrop.cropper('rotate', v);
        }
       
        
        function loadError(msg) {
            plus.nativeUI.closeWaiting();
            msgBox(msg);
        }
        
        function showPreview(model, para) {
            //$(".btn_submit", model).click(function () {
            //    alert("准备上传");
            //    sendData();
            //});
            var opt = gOptions;
            var len = gImgList.length;
            var m = $("#photo_info");
            $(".img_num", m).html(len + "张");
            $(".img_size", m).html(opt.paper);
            var std = opt.feeSTD[opt.size];
            if (std) {
                var uf = std.dwColorFee + std.dwMaterialFee;
                $(".img_price", m).html(app.cvtFee(uf) + "元/张");
                var fee = uf * len;
                $("#total_fee").html("￥" + app.cvtFee(fee));
                var balance = opt.balance.dwBalance + opt.balance.dwSubsidy;
                $("#wallet_balance").html(app.cvtFee(balance) + "元");
                opt.charge = fee - balance;
                if (opt.charge > 0) {
                    $("#charge_m").html("需支付" + app.cvtFee(opt.charge) + "元");
                }
            }
            //
            var swiper = $("#swiper_container");
            var con = $(".swiper-wrapper", swiper);
            var list = gImgList;
            for (var i = 0; i < list.length; i++) {
                con.append('<div class="swiper-slide"><img src="' + list[i].dataURL + '" alt=""></div>');
            }
            swiper.swiper();
        }
       
        //证件照合成（1、2寸）
        function composite(img, opt) {
            var c = document.createElement('canvas'),
                ctx = c.getContext('2d');
            var k = 1;
            var cw = 890, ch = 1250;
            if (opt.size == 285) {
                k = 1.5;
                cw = 1020 * k;
                ch = 1520 * k;
            }
              if(opt.mSize==1){//一寸证件 翻转相纸
                  var tmp=cw;
                  cw=ch;
                  ch=tmp;
              }
            c.width = cw;
            c.height = ch;
            ctx.rect(0, 0, c.width, c.height);
            ctx.fillStyle = '#ffffff';//画布填充颜色
            ctx.fill();
            if (opt.mSize == 1) {
                ctx.rotate(90 * Math.PI / 180);
                var w = 250, h = 350;
                if (opt.size == 285) {
                    var lt = w + 45;
                    var rd = h + 100;
                    for (var i = 0; i < 10; i++) {
                        ctx.drawImage(img, (45 + (i % 5) * lt) * k, (110 + (i > 4 ? rd : 0)) * k - cw, w * k, h * k);
                    }
                }
                else {
                    var lt = w + 50;
                    var rd = h + 50;
                    for (var i = 0; i < 8; i++) {
                        ctx.drawImage(img, (60 + (i % 4) * lt) * k, (70 + (i > 3 ? rd : 0)) * k - cw, w * k, h * k);
                    }
                }
            }
            else if (opt.mSize == 2) {
                var w = 350, h = 530;
                if (opt.size == 285) {
                    var lt = w + 100;
                    var rd = h + 150;
                    for (var i = 0; i < 4; i++) {
                        ctx.drawImage(img, (110 + (i % 2) * lt) * k, (155 + (i > 1 ? rd : 0)) * k, w * k, h * k);
                    }
                }
                else {
                    var lt = w + 50;
                    var rd = h + 50;
                    for (var i = 0; i < 4; i++) {
                        ctx.drawImage(img, (70 + (i % 2) * lt) * k, (80 + (i > 1 ? rd : 0)) * k, w * k, h * k);
                    }
                }
            }
            return c;
        }
        function compressImg(img) {
            //1寸 750x1050
            //2寸 700x1060
            //5寸 890×1270
            //6寸 1020×1520
            var big = 1250, small = 890;
            var mSize = gOptions.mSize;
            if (mSize == 6) {
                big = 1520 * 1.5;
                small = 1020 * 1.5;
            }
            else if (mSize == 1) {
                big = 1050;
                small = 750;
            }
            else if (mSize == 2) {
                big = 1060;
                small = 700;
            }
            var realW = img.naturalWidth;
            var realH = img.naturalHeight;
            var scale = 1;
            var isV = realH >= realW;//竖直图
            if (isV) {
                scale = big / realH > small / realW ? big / realH : small / realW;
            }
            else {
                scale = big / realW > small / realH ? big / realW : small / realH;
            }
            var width = realW * scale, heigth = realH * scale;
            var c = document.createElement('canvas'), ctx = c.getContext('2d');
            if (!isV) {
                c.width = heigth;
                c.height = width;
            }
            else {
                c.width = width;
                c.height = heigth;
            }
            ctx.rect(0, 0, c.width, c.height);
            ctx.fillStyle = '#ffffff';
            ctx.fill();
            if (!isV) {
                ctx.rotate(90 * Math.PI / 180);
                ctx.drawImage(img, 0, -heigth, width, heigth);
            }
            else {
                ctx.drawImage(img, 0, 0, realW, realH, 0, 0, width, heigth);
            }
            return c;
        }

       

        function sendData() {
            var list = gImgList;
            //var opt = gOptions;
            for (var i = 0; i < list.length; i++) {
                var blob = list[i].blob;
                if (blob) {
                    sendBlob(blob,0);
                };
            }
            function sendBlob(blob,tm) {
                xhr = new XMLHttpRequest();  // XMLHttpRequest 对象
                xhr.timeout = 10000;//服务器响应请求的超时时间
                xhr.open("post", gOptions.domain + "ajax/file.aspx?act=upload", true); //post方式，url为服务器请求地址，true 该参数规定请求是否异步处理。
                xhr.onload = function (evt) {
                    //$.hideLoading();
                    uploadComplete(evt.target.responseText, evt.target.status);
                }; //请求完成
                xhr.onerror = function () {
                    $.hideLoading();
                    msgBox("上传图片出错");
                }; //请求失败
                xhr.ontimeout = function () {
                    if (tm>0) {
                        $.hideLoading();
                        msgBox("连接超时");
                    }
                    else {
                        showInfo("超时重提");
                        setTimeout(function () {
                            $.hideLoading();
                            sendBlob(blob, 1);
                        }, 500);
                    }
                }
                xhr.upload.onprogress = function (evt) {//上传进度调用方法实现
                    if (evt.lengthComputable) {
                        showInfo("已上传：" + Math.round(evt.loaded * 100 / evt.total) + "%");
                    }
                };
                xhr.upload.onloadstart = function () {//上传开始执行方法
                    plus.nativeUI.showWaiting("正在上传图片...");
                };
                var form = new FormData(); // FormData 对象
                form.append("img", blob, app.getImgName(i, "照片")); // 文件对象
                xhr.send(form); //开始上传，发送form数据
            }
        }
        function uploadComplete(rltText, status) {
            if (status == 200 && rltText) {
                var rlt = JSON.parse(rltText);
                var opt = gOptions;
                if (rlt && rlt.ret == 1) {
                    console.log("上传文件成功:" + rltText);
                    //var base64 = list[i].dataURL;
                    //base64 = base64.substr(base64.indexOf("base64,") + 7)
                    var f = rlt.data;
                    var data = {
                        act: "new_print_task",
                        //file_pre: opt.type == "ident" ? "证件照" : "照片",
                        //file_base64: base64,
                        file: f.file,
                        fileName: f.fileName,
                        paper_id: opt.size,
                        prop: (0x8 | 0x1000),//彩色+照片
                        copies: 1
                    }
                    postData("print.aspx", data, function (rlt) {
                        if (rlt.ret == 1) {
                            var job = rlt.data.PrtJob;
                            if (opt.charge > 0) {
                                pay(opt.charge, function (v) {
                                    if (v > 0) {
                                        setTimeout(function () {
                                            outputPrint(job.dwJobId);
                                        }, 200);
                                    }
                                    else {
                                        location = opt.domain + "Auth.aspx?m=1&devsn=" + opt.devSN + "&op=print&type=photo";
                                    }
                                });
                            }
                            else {
                                outputPrint(job.dwJobId);
                            }
                        }
                        else {
                            msgBox(rlt.msg);
                        }
                    }, function () {
                        showInfo("正在生成任务...");
                    }, function () {
                        $.hideLoading();
                    });
                    return;
                } else {
                    msgBox(rlt ? rlt.msg : "上传文件失败");
                }
            } else {
                console.log("上传文件失败：" + status + "/" + rltText);
                msgBox("上传文件失败");
            }
            //上传未成功
            $.hideLoading();
        }
        
        function getBalance(comSN, callback) {
            postData("cac.aspx", {
                act: "get_balance",
                com_sn: comSN
            }, function (rlt) {
                if (rlt.ret == 1) {
                    gOptions.balance = rlt.data;
                    callback();
                }
                else {
                    msgBox(rlt.msg);
                }
            });
        }
        function calcSTD(stds) {
//          var str = "";
//          var prior = 0;
//          for (var i = 0; i < stds.length; i++) {
//              //过滤优先级低的费率 
//              if (stds[i].dwPriority > prior)
//                  prior = stds[i].dwPriority;
//          }
//          var kv = {};
//          for (var i = 0; i < stds.length; i++) {
//              var std = stds[i];
//              if (std.dwPriority < prior) continue;
//              kv[std.dwPaperID] = std;
//          }
          
           
                if (rlt.ret == 1) {
                    var data = rlt.data;
                    var opt = gOptions;
                    opt.acc = data.acc;
                    var printer = data.printer;
                    var pp = printer.dwTrayPaper1;
                    if (pp) {// && (pp == 285 || pp == 281)
                        opt.device = printer;
                        opt.feeSTD = calcSTD(data.feeSTD);
                        opt.size = pp;
                        if (opt.feeSTD[pp]) {
                            opt.paper = opt.feeSTD[pp].szFeeName;
                            opt.stamp = data.stamp;
                            getBalance(printer.dwComSN, callback);
                        }
                        else {
                            gotoErrorMsg("费率未配置");
                        }
                    }
                    else {
                        gotoErrorMsg("设备不存在");
                    }
                }
                else {
                    gotoErrorMsg(rlt.msg);
                }
           
            return kv;
        }

        function outputPrint(id) {
            var opt = gOptions;
            var data = {
                act: "output_task",
                task_id: id,
                dev_sn: opt.devSN,
                stamp: opt.stamp
            }
            postData("print.aspx", data, function (rlt) {
                $("#photo_submit").addClass("finished");
                if (rlt.ret == 1) {
                    type = "success";
                    title = "打印成功";
                    msg = "";
                }
                else {
                    type = "error";
                    title = "打印失败";
                    msg = rlt.msg;
                }
                location.href = "msg.html?type=" + type + "&title=" + title + "&msg=" + msg + "&dev=" + gOptions.devSN;
            });
        }
        function serverLog(msg) {
            postData("util.aspx", { act: "log", msg: msg });
        }
        function msgBox(msg, v) {
            if (!v) {
                v = "消息";
            }
            alert(msg, v);
        }
        function showInfo(i) {
            var t = $(".weui-toast_content:visible");
            (t.length > 0) && t.html(i);
        }
        function gotoPrintList() {
            location.href = "../JobSet.aspx?devsn=" + gOptions.devSN + "&op=print&type=photo";
        }
        function gotoErrorMsg(msg) {
            gRouter.goto("error_msg", function () {
                $("#jp_msg").html(msg);
            });
        }
        function backIndex() {
            gRouter.back(function () {
                $("input[type=file]").val("");
            });
        }
        function getQueue(callback) {
            postData("print.aspx", { act: "get_queue", dev_sn: gOptions.devSN }, function (rlt) {
                if (rlt.ret == 1) {
                    var data = rlt.data;
                    callback(data.queue);
                }
                else {
                    msgBox("不能打印，" + rlt.msg + "，请稍候重试。", "错误");
                }
            });
        }  
         function router(container, templates) {
            var con = $(container);
            var tpls = $(templates);
            var history = new Array();
            tpls.detach();
            this.goto = function (id, callback, para) {
                var state;
                var page = tpls.children("#" + id);
                if (page) {
                    var model = con.children(".model_" + id);
                    if (model.length > 0) {
                        var len = history.length - 1;
                        for (var i = len; i > -1; i--) {
                            if (history[i].id != id) {
                                history.pop().remove();
                            }
                            else {
                                show(model);
                                break;
                            }
                        }
                        state = "exist";
                    }
                    else {
                        history.length > 0 && hide(history[history.length - 1]);
                        model = $("<div class='active rt-model model_" + id + "' style='display:none'>" + tpls.children("#" + id).html() + "</div>");
                        history.length > 0 ? con.append(model) : con.html(model);
                        history.push(model);
                        show(model);
                        state = "new";
                    }
                    callback && callback(model, para, state);
                }
            }
            this.back = function (callback, para) {
                if (history.length > 1) {
                    history.pop().remove();
                    var model = history[history.length - 1];
                    show(model);
                    callback && callback(model, para);
                }
            }
            function show(model) {
                model.addClass("active");
                model.fadeIn();
            }
            function hide(model) {
                model.removeClass("active");
                model.hide();
            }
        }

        //获取req
        function getReq() {
            var req = new _QueryString();
            return req;
            function _QueryString() {
                var name, value, i;
                var str = location.href;
                var num = str.indexOf("?")
                str = str.substr(num + 1);
                str = str.split("#")[0];
                var arrtmp = str.split("&");
                for (i = 0; i < arrtmp.length; i++) {
                    num = arrtmp[i].indexOf("=");
                    if (num > 0) {
                        name = arrtmp[i].substring(0, num);
                        value = arrtmp[i].substr(num + 1);
                        this[name] = value;
                    }
                }
            }
        }
        //app
        var adb = {
            os: (function (ua) {
                var ret = {},
                    // osx = !!ua.match( /\(Macintosh\; Intel / ),
                    android = ua.match(/(?:Android);?[\s\/]+([\d.]+)?/),
                    ios = ua.match(/(?:iPad|iPod|iPhone).*OS\s([\d_]+)/);
                // osx && (ret.osx = true);
                android && (ret.android = parseFloat(android[1]));
                ios && (ret.ios = parseFloat(ios[1].replace(/_/g, '.')));
                return ret;
            })(navigator.userAgent),
            getImgName: function (i, pre) {
                var now = new Date();
                var y = now.getYear() + '';
                var M = now.getMonth() + 1 + '';
                var d = now.getDate() + '';
                var h = now.getHours() + '';
                var m = now.getMinutes() + '';
                var s = now.getSeconds() + '';
                return (pre || "img") + "_" + y + M + d + h + m + s + "_" + i + ".jpg"
            }
        }
        adb.cvtFee = function (fee) {
            var minus = "";
            if (fee < 0) {
                minus = "-";
                fee = -fee;
            }
            var f = fee % 100;
            if (f == 0) f = "00";
            else if (f > 9) f = (f + "0").substr(0, 2);
            else f = "0" + f;
            return minus + parseInt(fee / 100) + "." + f;
        }
      });
       function compressImg(img) {
        var realW = img.naturalWidth;
        var realH = img.naturalHeight;
        var scale = 1;
        var limit = 1400;
        if(realW > limit) {
          scale = limit / realW;
        }
        if(realH > limit) {
          var r = limit / realH;
          if(r < scale) scale = r;
        }
        var width = realW * scale,
          heigth = realH * scale;
        var c = document.createElement('canvas'),
          ctx = c.getContext('2d');
        c.width = width;
        c.height = heigth;
        ctx.rect(0, 0, c.width, c.height);
        ctx.fillStyle = '#ffffff';
        ctx.fill();
        ctx.drawImage(img, 0, 0, realW, realH, 0, 0, width, heigth);
        return c;
      };
       function getDataURL(c) {
            var res = {};
            res.dataURL = c.toDataURL("image/jpeg", 0.95);
            res.canvas = c;
            res.blob = dataURLtoBlob && dataURLtoBlob(res.dataURL);
            return res;
        }
       
       function submitCrop() {
            var crop = gCrop;
//          if (crop && crop.index > -1) {
                plus.nativeUI.showWaiting("生成预览..");
                var canvas = crop.cropper('getCroppedCanvas', { fillColor: "#fff" });
                var opt = gOptions;
//              if (opt.type == "ident") {
//                  gImgList[crop.index] = getDataURL(composite(canvas, opt));
//              }
//              else {
//                  gImgList[crop.index] =getDataURL(canvas);
    
//              }
                imgUrl=canvas.toDataURL("image/png",0.95)
//              alert(JSON.stringify(getDataURL(canvas)));
                plus.nativeUI.closeWaiting();
                gotoPreview();
                //sendData(cpsImgData.substr(cpsImgData.indexOf("base64,") + 7));
//                     if(cpsImgData) {
          baseImgFile(adb.getImgName(0, "证件"),imgUrl,50,function(i){
                          app.uploadFileByPath(i.target);      
          });
                     
//      }
//             outputPrint(job.dwJobId);
            }

       function baseImgFile(uid, base64, quality, callback) {
        quality = quality || 10;
        callback = callback || $.noop;
        var bitmap = new plus.nativeObj.Bitmap();
        // 从本地加载Bitmap图片
        bitmap.loadBase64Data(base64, function() {
            bitmap.save("_doc/" + uid + ".jpg", {
                overwrite: true,
                quality: quality
            }, function(i) {
                callback(i);
                      console.log('保存图片成功：'+JSON.stringify(i));
            }, function(e) {
                console.log('保存图片失败：' + JSON.stringify(e));
            });
        }, function(e) {
            console.log('加载图片失败：' + JSON.stringify(e));
        });
    };
            //初始化图片添加器
function init_image_add() {
    //上传图片上限,超过不现实加号
    if(question.files.length >= IMG_MAX_NUM)
        return;
    var placeholder = document.createElement('div');
    placeholder.setAttribute('class', 'image-item space');

    //删除图片
    var closeButton = document.createElement('div');
    closeButton.setAttribute('class', 'image-close');
    closeButton.innerHTML = 'X';
    //小X的点击事件
    closeButton.addEventListener('tap', function(event) {
        removeFile(getChildrenIndex(placeholder)); //删除实际图片数组元素，先删除数组中的
        imageList.removeChild(placeholder); //删除ui，必须后删除，否则节点会找不到了
        if(question.files.length >= IMG_MAX_NUM - 1)
            init_image_add();
        event.stopPropagation();
    }, false);

    placeholder.addEventListener('tap', function(event) {
        var btnArray = [{
            title: "相册"
        }, {
            title: "拍照"
        }];

        //actionsheet
        plus.nativeUI.actionSheet({
            title: "选择图片",
            cancel: "取消",
            buttons: btnArray
        }, function(e) {
            var i = e.index;
            switch(i) {
                case 0:
                    break;
                case 1:
                    plus.gallery.pick(function(e) {
                        plus.io.resolveLocalFileSystemURL(e, function(entry) {
                            var url = entry.toLocalURL();
                            var name = url.substr(e.lastIndexOf('/') + 1);

                            //压缩取得缩略图
                            plus.zip.compressImage({
                                src: url,
                                dst: '_doc/' + name,
                                overwrite: true,
                                quality: 50,
                                height: '300px',
                                clip: {
                                    top: "25%",
                                    left: "25%",
                                    width: "300px",
                                    height: "300px"
                                }
                            }, function(zip) {
                                placeholder.style.backgroundImage = "url('" + zip.target + "')";
                                if(!placeholder.classList.contains('space')) { //已有图片
                                    exFile(getChildrenIndex(placeholder), url);
                                } else { //加号
                                    placeholder.classList.remove('space');
                                    addFile(url);
                                    init_image_add();
                                }
                            }, function(zip) {
                                mui.toast('压缩失败！');
                            });

                        }, function(e) {
                            console.log("读取相册文件错误：" + e.message);
                        });

                    }, function(e) {
                        console.log(e.message);
                    }, {});
                    break;
                case 2:
                    plus.camera.getCamera().captureImage(function(e) {
                        plus.io.resolveLocalFileSystemURL(e, function(entry) {
                            var url = entry.toLocalURL();
                            var name = url.substr(e.lastIndexOf('/') + 1);

                            //压缩
                            plus.zip.compressImage({
                                src: url,
                                dst: '_doc/' + name,
                                overwrite: true,
                                quality: 50,
                                height: '300px',
                                clip: {
                                    top: "25%",
                                    left: "25%",
                                    width: "300px",
                                    height: "300px"
                                }
                            }, function(zip) {
                                placeholder.style.backgroundImage = "url('" + zip.target + "')";
                                if(!placeholder.classList.contains('space')) { //已有图片
                                    exFile(getChildrenIndex(placeholder), url);
                                } else { //加号
                                    placeholder.classList.remove('space');
                                    addFile(url);
                                    init_image_add();
                                }
                            }, function(zip) {
                                mui.toast('压缩失败！');
                            });
                        }, function(e) {
                            console.log("读取拍照文件错误：" + e.message);
                        });
                    }, function(s) {
                        console.log("error" + s);
                    }, {});
                    break;
            }
        });

    }, false);
    };
              function submitPrint() {
//               app.uploadFileByPath();
           init_image_add()
//         app.showRecharge({"sum":std.dwColorFee});
//          if ($("#photo_submit").hasClass("finished")) {
//              $.confirm("重复提交");
//              return;
//          }
//          getQueue(function (i) {
//              if (i > 0) {
//                  $.confirm('前边还有' + i + '张照片未输出，确认继续？', function () {
//                      sendData();
//                  });
//              }
//              else {
//                  sendData();
//              }
//          });
        
        }
              var std;
             function gotoPreview() {
//          if (gImgList.length > 0) {
//                gRouter.goto("preview", showPreview);//测试
//              var opt = gOptions;
//              if (opt.feeSTD && opt.feeSTD[opt.size]) {
//                  gRouter.goto("preview", showPreview);
//          var opt = gOptions;
//          var len = gImgList.length;
//          var m = $("#photo_info");
//          $(".img_num", m).html(len + "张");
//          $(".img_size", m).html(opt.paper);
//          var std = opt.feeSTD[opt.size];
//          if (std) {
//              var uf = std.dwColorFee + std.dwMaterialFee;
//              $(".img_price", m).html(adb.cvtFee(uf) + "元/张");
//              var fee = uf * len;
//              $("#total_fee").html("￥" + app.cvtFee(fee));
//              var balance = opt.balance.dwBalance + opt.balance.dwSubsidy;
//              $("#wallet_balance").html(app.cvtFee(balance) + "元");
//              opt.charge = fee - balance;
//              if (opt.charge > 0) {
//                  $("#charge_m").html("需支付" + app.cvtFee(opt.charge) + "元");
//              }
//          }
//          //
            var swiper = $("#swiper_container");
            var con = $(".swiper-wrapper", swiper);
//          swiper.height(document.body.clientHeight*0.74);
//          var list = gImgList;
//          for (var i = 0; i < list.length; i++) {
////              con.append('<div class="swiper-slide"><img src="' + list[i].dataURL + '" alt=""></div>');
           con.append('<div class="swiper-slide"><img src="' + imgUrl + '" alt=""></div>');
//          }
                      proj.print.getFeeSTD(function(rlt) {
          var stds = rlt.data;
          var prior = 0;
          for(var i = 0; i < stds.length; i++) {
            //过滤优先级低的费率 
            if(stds[i].dwPriority > prior){
              prior = stds[i].dwPriority;}
          }
          for(var i = 0; i < stds.length; i++) {
             std = stds[i];
//          alert(JSON.stringify(std))
            if(std.dwPriority < prior) continue;
           $(".img_num").html("1张");
           $(".img_size").html(std.szFeeName);
           $(".img_price").html(app.cvtFee(std.dwColorFee) + "元/页");
           $("#total_fee").html("￥"+app.cvtFee(std.dwColorFee));
           $("#charge_m").html("需支付" + app.cvtFee(std.dwColorFee)+ "元");
          }
           },{
          "dev_sn":devSN,
          "fee_type":0
        });  
        app.getBalance(function(fee,bal) {
          $("#wallet_balance").html(fee/100+"元");
          },{
          "dev_sn":devSN    
            });
//          swiper.swiper();
                   $("#photo_normal").css("display","none");
                   $("#preview").show();
//              }
//              else {
//                  app.toast("缺少收费标准，不能打印");
//              }
//          }
        
        }
    </script>
  </body>

</html>